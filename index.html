<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Deine Dify-Verbindung â€“ korrigierter Endpoint
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const API_URL = "https://api.dify.ai/v1/chat-message"; // â† ohne "s" !!!
  const API_KEY = "app-3HX9LQrcRg59uNtRFAJv8Mzr";

  let conversationId = null;
  let isSending = false;

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send-btn");

  function addMessage(text, isUser = false, isError = false) {
    const msg = document.createElement("div");
    msg.className = `bubble ${isUser ? "user" : "agent"} ${isError ? "error" : ""}`;
    msg.innerHTML = text.replace(/\n/g, "<br>");
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendMessage() {
    if (isSending) return;

    const message = input.value.trim();
    if (!message) return;

    isSending = true;
    sendBtn.disabled = true;
    sendBtn.textContent = "Sendet...";

    addMessage(message, true);
    input.value = "";

    try {
      const body = {
        inputs: {},
        query: message,
        response_mode: "blocking",
        user: "web-user-" + Date.now(),
        ...(conversationId && { conversation_id: conversationId })
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(
          `Status ${res.status} â€“ ${errorData.message || res.statusText || "Unbekannter Fehler"}`
        );
      }

      const data = await res.json();

      addMessage(data.answer || "[Keine Antwort erhalten]", false);

      if (data.conversation_id) {
        conversationId = data.conversation_id;
      }

    } catch (err) {
      console.error("API-Fehler:", err);
      addMessage(
        `Verbindung zu Green fehlgeschlagen ğŸ˜”<br><br>` +
        `Fehler: ${err.message}<br><br>` +
        `Aktuelle URL: ${API_URL}<br>` +
        `Tipps:<br>` +
        `1. App in Dify neu verÃ¶ffentlichen<br>` +
        `2. Neuen API-Key generieren<br>` +
        `3. Im Browser F12 â†’ Network-Tab schauen`,
        false,
        true
      );
    }

    isSending = false;
    sendBtn.disabled = false;
    sendBtn.textContent = "Senden";
    input.focus();
  }

  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  window.onload = () => {
    addMessage(
      "Hey! ğŸ‘‹ Ich bin Green â€“ dein kleiner grÃ¼ner Fahrt-Freund.<br><br>" +
      "Wo mÃ¶chtest du abgeholt werden? Schreib einfach deine Adresse oder sag â€aktueller Standortâ€œ.",
      false
    );
  };
</script>
